<!DOCTYPE html>
<html lang="en">
    {% load static %}
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Dashboard - SB Admin</title>
        <link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet" />
        <link href="{% static 'notes/css/styles.css' %}" rel="stylesheet" />
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <style>
            @media screen and (max-width:576px) {
                .container {
                    width: 100%;
                } 
    
                .statistiques_Globales{
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    width: 100%;
                    margin: auto;
                
                }
            }
    
            .date{
                display: flex;
            }
    
            .date{
                display: flex;
                width: 40%;
            }
            .statistiques_Globales{
                display: flex;
    
                justify-content: center;
                width: 100%;
                margin: auto;
            
            }
            .carres{
                margin: 5px;
                box-shadow: 5px 5px 5px rgb(43, 42, 42);
            }
            .carres h2{
                color: rgb(255, 251, 0);
                font-weight: 700;
                text-align: center;
            }
            .carres h1{
                color: white;
                font-weight: 600;
                text-align: center;
               
            }
            @media screen and (min-width:576px) {
                
           
            .date{
                display: flex;
                width: 40%;
            }
            .statistiques_Globales{
                display: flex;
                justify-content: center;
                width: 100%;
                margin: auto;
            
            }
            .carres{
                margin: 5px;
                box-shadow: 5px 5px 5px rgb(43, 42, 42);
            }
            .carres h2{
                color: rgb(255, 251, 0);
                font-weight: 700;
                text-align: center;
            }
            .carres h1{
                color: white;
                font-weight: 600;
                text-align: center;
               
            }
        }
        </style>
    {% include "_partials/header_link.html" %}
    </head>
    <body class="sb-nav-fixed">
        <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
            <!-- Navbar Brand-->
            <a class="navbar-brand ps-3" href="#">Présence</a>
            <!-- Sidebar Toggle-->
            <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!"><i class="fas fa-bars"></i></button>
        </nav>
        <div id="layoutSidenav">
            <div id="layoutSidenav_nav">
                <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
                    <div class="sb-sidenav-menu">
                        <div class="nav">
                            <div class="sb-sidenav-menu-heading">{{ matiere.libele }}</div>
                            <a class="nav-link" href="{% url 'presence' matiere.slug %}">
                                <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                                Présence
                            </a>   
                            <a class="nav-link" href="{% url 'statistiques' matiere.slug %}">
                                <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                                Statistiques
                            </a>
                        </div>
                    </div>
                </nav>
            </div>
            <div id="layoutSidenav_content">
                <main>
                    <section class="page-title-section overlay" data-background="{% static 'images/backgrounds/page-title.jpg' %}">
                        <div class="container">
                            <div class="row">
                                <div class="col-md-8">
                                    <ul class="list-inline custom-breadcrumb mb-2">
                                        <li class="list-inline-item"><a class="h2 text-primary font-secondary" href="{% url 'index'%}">Accueil</a></li>
                                        <li class="list-inline-item text-white h3 font-secondary nasted">Présence et Statistiques</li>
                                    </ul>
                                    <p class="text-lighten mb-0">Ici vous pouvez modifier les status de présences de vos Etudiants et visualiser les statistiques sur les niveaux d'évolutions, leur taux d'absence et bien d'autres</p>
                                </div>
                            </div>
                        </div>
                    </section>
                    <div class="container-fluid px-4">
                        <h1 style="color: blue; font-weight:1000">Statistiques Générales de présence en {{ matiere.libele }}</h1>
                        <div class="container d-flex flex-wrap presence" style="padding: 2%; width:90%; display:block">
                            <div class="row" style="width:100%;">
                                <a href="{% url 'presence' matiere.slug %}" class="col btn btn-outline-primary">Présence du jour</a>
                                <a href="#" class="col btn btn-primary">Statistiques Générales</a>
                                <div class="statistiques_Globales container">
                                    <div class="carres col-sm bg">
                                        <canvas id="overallChart"></canvas>
                                    </div>
                                </div>
                                <div class="statistiques_Globales container">
                                    <div class="carres col-sm bg">
                                        <canvas id="genderChart"></canvas>
                                    </div>
                                </div>
                                <input class="col-2 mt-1 mb-3 form-control" type="search" name="Recherche" id="Searche_Etudiant" placeholder="Chercher un Etudiant" style="right: 0px;">
                            </div>
                            <form method="post" action="#" class="needs-validation" novalidate style="width: 100%;">
                                {% csrf_token %}
                                <input type="hidden" name="matiere_slug" value="{{ matiere.slug }}">
                                {% for Etudiant in Etudiants %}
                                <a href="{% url 'statistique_etudiant' Etudiant.user.username matiere.slug %}">
                                    <div class="Etudiant_note row mb-2" style="width:100%">
                                        {% if Etudiant.photo_profile %}
                                            <img class="col-3" src="{{ Etudiant.photo_profile.url }}" alt="profile">
                                        {% else %}
                                            <img class="col-3" src="" alt="profile">
                                        {% endif %}
                                        <h3 class="col-6"><span style="color: blue;">{{ Etudiant.user.username }} </span>{{ Etudiant.user.last_name.upper }} {{ Etudiant.user.first_name.upper }}</h3>
                                    </div>
                                </a>
                                {% endfor %}
                            </form>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script src="{% static 'notes/js/scripts.js' %}"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js" crossorigin="anonymous"></script>
        <script src="{% static 'notes/assets/demo/chart-area-demo.js' %}"></script>
        <script src="{% static 'notes/assets/demo/chart-bar-demo.js' %}"></script>
        <script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js" crossorigin="anonymous"></script>
        <script src="{% static 'notes/js/datatables-simple-demo.js' %}"></script>
        <script src="{% static 'Application/style/jquery-3.7.1.min.js' %}"></script>
        <script>
            $('#Searche_Etudiant').on('input', function() {
                var searchTerm = $(this).val().toLowerCase();
                $('.Etudiant_note').each(function() {
                    var etudiantUsername = $(this).find('.matricule_note').text();
                    var etudiantLastName = $(this).find('.col-6').text();
                    var usernameIndex = etudiantUsername.toLowerCase().indexOf(searchTerm);
                    var lastNameIndex = etudiantLastName.toLowerCase().indexOf(searchTerm);
                    if (usernameIndex > -1 || lastNameIndex > -1) {
                        $(this).show();
                        if (usernameIndex > -1) {
                            $(this).find('.matricule_note').html(highlightMatch(etudiantUsername, usernameIndex, searchTerm.length));
                        }
                        if (lastNameIndex > -1) {
                            $(this).find('.col-6').html(highlightMatch(etudiantLastName, lastNameIndex, searchTerm.length));
                        }
                    } else {
                        $(this).hide();
                    }
                });
            });
            function highlightMatch(text, index, length) {
                var highlightedText = text.substring(0, index) + '<span class="highlight">' + text.substring(index, index + length) + '</span>' + text.substring(index + length);
                return highlightedText;
            }
            function present(element) {
                document.getElementById(element).value = "present";
                btn = document.getElementsByClassName(element);
                btn[0].classList.add("btn-success");
                btn[1].classList.remove("btn-danger");
            }
            function absent(element) {
                document.getElementById(element).value = "absent";
                btn = document.getElementsByClassName(element);
                btn[0].classList.remove("btn-success");
                btn[1].classList.add("btn-danger");
            }
        </script>
        <style>
            .highlight {
                background-color: yellow;
                font-weight: bold;
            }
        </style>
        {% include "_partials/footer_link.html" %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const ctxOverall = document.getElementById('overallChart').getContext('2d');
                const ctxGender = document.getElementById('genderChart').getContext('2d');
                
                // Overall Presence Pie Chart
                new Chart(ctxOverall, {
                    type: 'doughnut',
                    data: {
                        labels: ['Présence', 'Absence'],
                        datasets: [{
                            label: 'Taux de présence et d\'absence',
                            data: [{{ taux_presents }}, {{ taux_absents }}],
                            backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(255, 99, 132, 0.6)'],
                            borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(tooltipItem) {
                                        return tooltipItem.label + ': ' + tooltipItem.raw + '%';
                                    }
                                }
                            }
                        }
                    }
                });

                // Gender-wise Presence Bar Chart
                new Chart(ctxGender, {
                    type: 'bar',
                    data: {
                        labels: ['Hommes', 'Femmes'],
                        datasets: [
                            {
                                label: 'Présence',
                                data: [{{ taux_garcons_presents }}, {{ taux_filles_presents }}],
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Absence',
                                data: [{{ taux_garcons_absents }}, {{ taux_filles_absents }}],
                                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Pourcentage'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(tooltipItem) {
                                        return tooltipItem.dataset.label + ': ' + tooltipItem.raw + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            });
        </script>
    </body>
</html>
